# Claude 連携

GUI と Claude Chat の両方から SkillGraph を編集できる仕組みの解説。

## 設計目標

- React Flow GUI でノードツリー（SkillGraph）を編集できる
- Claude Code のチャットから自然言語で同じグラフを編集できる
- どちらで編集しても、最終的には同じ SKILL.md / Graph に反映される

## 責務分離

```
┌──────────────────┐     ┌──────────────────┐
│       GUI        │     │   Claude Chat    │
│  (React Flow)    │     │  (自然言語指示)   │
└────────┬─────────┘     └────────┬─────────┘
         │                        │
         ▼                        ▼
┌─────────────────────────────────────────────┐
│              バックエンド                    │
│  - Operation の検証                         │
│  - Graph の更新                             │
│  - 不変条件のチェック                        │
│  - SKILL.md の再生成                        │
└─────────────────────────────────────────────┘
```

Claude は「提案と操作記述」を返し、適用と永続化の責務はサーバが持つ。

## Chat からの編集フロー

1. ユーザーが Chat で指示

   > 「git-reviewer スキルに、コミットメッセージを整形するノードを追加して」

2. Claude が現状の Graph を取得

3. Claude が指示を解釈し、Operation 列を生成

4. バックエンドが Operation を検証・適用

5. Graph 更新 → SKILL.md 再生成

6. GUI は再読み込みで変更を反映

## Claude への入力

Claude には以下の情報を渡す：

### システムメッセージ

- 役割：「SkillGraph 編集アシスタント」
- 制約：JSON 形式での出力、許可された Operation のみ
- 不変条件：ID 一意性、エッジ整合性、循環制約など

### ユーザーメッセージ

- 現在の SkillGraph（必要に応じて簡略化）
- ユーザーからの自然言語指示
- 期待する出力フォーマット

## Claude からの出力

```json
{
  "operations": [
    {
      "operationId": "op1",
      "kind": "addNode",
      "humanReadableDescription": "コミット整形ノードを追加",
      "node": {
        "id": "n3",
        "type": "instruction",
        "data": { "label": "コミットメッセージを整形" }
      },
      "insertAfter": "n2"
    }
  ],
  "summary": "レビュー結果の後にコミット整形ステップを追加しました。"
}
```

## 状態遷移と一貫性

### 編集の原子性

- 1 回のリクエスト = Operation 集合
- 「すべて適用」か「すべて拒否」のみ
- 途中状態は永続化されない

### バージョン管理

- SkillGraph は単調増加の version 番号を持つ
- リクエストにはクライアントが見ている version を含める
- 不一致時はエラー（再読み込みを促す）

### 競合ポリシー（MVP）

- Last-Write-Wins（最後に保存したものが勝ち）
- 将来拡張で競合検出・マージを検討

## エラーハンドリング

### バリデーションエラー

不変条件違反時：

- 編集セットを破棄
- Graph は変更しない
- エラー内容（どの制約に違反したか）を表示

### Claude 出力の不整合

JSON 形式でない、必須フィールドがない等：

- 「この編集は適用できませんでした」と通知
- Graph は変更しない
- 必要に応じてリトライ（回数制限付き）

### タイムアウト

Claude API 呼び出しがタイムアウト：

- 「時間がかかりすぎたため編集を適用できませんでした」と通知
- Graph は変更しない

## ユーザーへのフィードバック

### 成功時

- 「Claude による編集を適用しました」通知
- 変更内容（Operation）の簡易ログを表示

### 失敗時

- 原因カテゴリを区別して表示
  - 検証エラー
  - Claude 出力エラー
  - 通信エラー
- 再試行のガイダンス提示
