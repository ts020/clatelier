# スキルの発動率を検証する

スキルが期待通りに自動発動するかを検証する手順。

## 背景

スキルは Claude Code が自動発見・自動実行するが、`description` の書き方によって発動率が変わる。効果的な description を特定するには検証が必要。

## 前提条件

- Claude Code CLI がインストールされていること
- `.claude/skills/` ディレクトリにアクセスできること

## 基本的な検証方法

### 1. 非対話モードでプロンプトを実行

```bash
claude -p "テストプロンプト"
```

新しいプロセスが起動するため、最新のスキルが読み込まれる。

### 2. JSON 形式で出力を取得

```bash
claude -p "テストプロンプト" --output-format json
```

構造化された出力で結果を解析しやすい。

### 3. デバッグモードで詳細確認

```bash
claude -p "テストプロンプト" --debug
```

## A/B テストの実施

### Step 1: テストスキルを複数パターンで作成

```
.claude/skills/
├── test-pattern-a/SKILL.md
├── test-pattern-b/SKILL.md
└── test-pattern-c/SKILL.md
```

各スキルに**固有のマーカー**を含める：

```yaml
# test-pattern-a/SKILL.md
---
name: test-pattern-a
description: ファイルを読み取る
allowed-tools: Read
---

# Test Pattern A

## 指示

1. 「パターンAが発動しました」と最初に宣言する
2. 指定されたファイルを読み取る
```

### Step 2: description パターン例

| パターン | description |
|---------|-------------|
| A（シンプル） | `ファイルを読み取る` |
| B（ユースケース） | `ファイルの内容を確認したい時に使用します` |
| C（トリガー列挙） | `「ファイルを読んで」「内容を見せて」「中身を確認」で使用` |

### Step 3: 検証スクリプト

```bash
#!/bin/bash
# test-skill-invocation.sh

PROMPTS=(
  "ファイルを読んで"
  "内容を見せて"
  "中身を確認して"
  "ファイルの内容を教えて"
)

for prompt in "${PROMPTS[@]}"; do
  echo "=== Testing: $prompt ==="
  result=$(claude -p "$prompt" 2>&1)

  if echo "$result" | grep -q "パターンAが発動"; then
    echo "→ Pattern A invoked"
  elif echo "$result" | grep -q "パターンBが発動"; then
    echo "→ Pattern B invoked"
  elif echo "$result" | grep -q "パターンCが発動"; then
    echo "→ Pattern C invoked"
  else
    echo "→ No skill invoked"
  fi
  echo ""
done
```

### Step 4: 結果を記録

| プロンプト | Pattern A | Pattern B | Pattern C |
|-----------|:---------:|:---------:|:---------:|
| ファイルを読んで | | | |
| 内容を見せて | | | |
| 中身を確認して | | | |

## 単一スキルのイテレーション

既存スキルの description を改善する場合：

```bash
# 1. SKILL.md を編集
vim .claude/skills/my-skill/SKILL.md

# 2. テスト実行
claude -p "期待するトリガープロンプト"

# 3. 発動確認 → 発動しなければ 1 に戻る
```

## 注意事項

### スキル変更の反映タイミング

| 操作 | 反映タイミング |
|------|---------------|
| SKILL.md 編集 | 次回 `claude` コマンド実行時 |
| スキル追加 | 次回 `claude` コマンド実行時 |
| スキル削除 | 次回 `claude` コマンド実行時 |

`claude -p` は毎回新しいプロセスなので、変更は即座に反映される。

### 競合の回避

複数のテストスキルが同時に存在すると競合する可能性がある。

```bash
# 他のテストスキルを一時的に無効化
mv .claude/skills/test-pattern-b .claude/skills/_test-pattern-b
```

## 実験結果（2024年実施）

### 第1回実験: デフォルト権限モード

以下の description パターンでテストスキルを作成：

| パターン | description |
|---------|-------------|
| A | `ファイルを読み取る` |
| B | `ファイルの内容を確認したい時に使用します。テキストファイルやソースコードの中身を見たい場合に最適です。` |
| C | `「ファイルを読んで」「内容を見せて」「中身を確認して」「ファイルの内容を教えて」などのリクエストで使用します。` |

各スキルにマーカー出力指示を含めて発動を検証。

#### 結果（デフォルト権限）

| テスト項目 | 結果 | 観察 |
|-----------|:----:|------|
| スキル認識 | ✅ | 全スキルがリスト表示される |
| description マッチでの適用 | ⚠️ | コンテキストとして適用されるが「発動」ではない |
| スキル内容の反映 | ✅ | 情報・知識として回答に反映される |
| 指示（マーカー出力等）の強制 | ❌ | 無視される |

### 第2回実験: 権限設定の調査

JSON 出力で詳細を確認したところ、**Skill ツールが権限拒否**されていることが判明：

```json
{"name":"Skill","input":{"skill":"line-counter"}}
// ↓
{"content":"Execute skill: line-counter","is_error":true}
// ↓
"permission_denials":[{"tool_name":"Skill"...}]
```

### 第3回実験: Skill ツールを許可

`--allowed-tools` で Skill ツールを明示的に許可：

```bash
claude -p "sample.txt の行数を数えて" --allowed-tools "Skill,Bash,Read"
```

#### 結果（Skill 許可時）

```
📊 Line Counter
━━━━━━━━━━━━━━━
ファイル: sample.txt
行数: 5 行
━━━━━━━━━━━━━━━
```

**スキルの指示が完全に守られた！**

### 重要な発見

**デフォルト権限モードでは Skill ツールがブロックされている**

| 権限設定 | Skill ツール | 指示の遵守 |
|---------|:-----------:|:---------:|
| デフォルト | ❌ ブロック | ❌ 無視される |
| `--allowed-tools "Skill,..."` | ✅ 動作 | ✅ 守られる |
| `--dangerously-skip-permissions` | ✅ 動作 | ✅ 守られる |

### スキルを正しく動作させる方法

#### 方法1: `--allowed-tools` で許可（推奨）

```bash
claude -p "プロンプト" --allowed-tools "Skill,Bash,Read,Write"
```

必要なツールのみを許可するため、比較的安全。

#### 方法2: 全権限バイパス（非推奨）

```bash
claude -p "プロンプト" --dangerously-skip-permissions
```

すべての権限チェックをスキップするため危険。

### 補足: デフォルトで Skill がブロックされる理由

スキルは「コンテキスト拡張」として設計されているため、デフォルトでは:

- スキルの内容は Claude のコンテキストに追加される
- しかし Skill ツール（明示的な発動）は権限が必要
- 結果として、スキル内容は「参考情報」として扱われる

```
スキル ≠ 厳密なルール/プログラム
スキル = Claude に与える追加コンテキスト/ガイドライン
（ただし Skill ツールを許可すれば厳密な実行も可能）
```

## スキルが効果的なケース

| ケース | 例 |
|-------|-----|
| ドメイン知識の提供 | プロジェクト固有の情報、用語定義 |
| 推奨アプローチの提示 | 「このプロジェクトでは X を使う」 |
| ツール制限 | `allowed-tools` で使用ツールを限定 |
| 応答スタイルのガイド | 「簡潔に答える」「日本語で回答」 |

## スキルが効果的でないケース

| ケース | 理由 |
|-------|------|
| 厳密な出力形式の強制 | Claude は自身の判断で形式を決める |
| 組み込みツールの置き換え | Read 等は直接使用される |
| マーカー/識別子の出力 | 無視されやすい |

## 推奨: 効果的なスキル設計

### 1. 知識提供型

```yaml
---
name: project-context
description: このプロジェクトについて質問された時に使用します
---

# プロジェクト情報

- 名前: My Project
- 言語: TypeScript
- フレームワーク: React
- テスト: Vitest
```

### 2. ガイドライン型

```yaml
---
name: code-style
description: コードを書く時のスタイルガイド
---

# コーディング規約

- 関数は小さく保つ
- 早期リターンを使う
- コメントは「なぜ」を書く
```

### 3. ツール制限型

```yaml
---
name: safe-reader
description: ファイルを安全に読み取る（書き込み不可）
allowed-tools: Read, Glob, Grep
---

# 読み取り専用モード

このスキルでは書き込み操作を行いません。
```

## スキル vs サブエージェント比較

### サブエージェントとは

`.claude/agents/` ディレクトリに配置するエージェント定義。Task ツール経由で呼び出される。

```
.claude/agents/
└── line-counter.md
```

### 比較実験

同じ「行数カウント」タスクをスキルとサブエージェントで実装し、動作を比較。

#### サブエージェント定義

```yaml
---
name: line-counter
description: ファイルの行数をカウントする専用エージェント。「行数を数えて」「何行ある？」などのリクエストで使用。
allowed-tools: Bash, Read
---

# Line Counter Agent

あなたはファイルの行数をカウントする専門エージェントです。

## 必須の出力形式

回答は**必ず**以下の形式で出力してください：

🤖 Line Counter Agent
━━━━━━━━━━━━━━━━━━━━
ファイル: {ファイル名}
行数: {N} 行
━━━━━━━━━━━━━━━━━━━━
```

#### 結果比較

| 項目 | スキル（デフォルト権限） | スキル（Skill許可） | サブエージェント |
|------|:----------------------:|:------------------:|:---------------:|
| 権限設定 | 不要 | `--allowed-tools "Skill,..."` | 不要 |
| 自動発動 | ⚠️ コンテキストのみ | ✅ 完全発動 | ✅ 自動呼び出し |
| 指示遵守 | ❌ 無視される | ✅ 守られる | ✅ 守られる |
| 出力形式 | ❌ 自由形式 | ✅ 指定形式 | ✅ 指定形式 |
| 親の再フォーマット | - | - | ⚠️ 発生することがある |

### サブエージェントの特徴

**メリット:**
- デフォルト権限で動作（追加設定不要）
- 指示が確実に守られる
- 複雑なタスクを分離できる

**注意点:**
- 親エージェントが結果を再フォーマットすることがある
- 「結果をそのまま表示して」と明示すると形式が保持される

### 使い分けガイド

| ユースケース | 推奨 |
|-------------|------|
| 知識・コンテキスト提供 | スキル |
| コーディング規約 | スキル |
| 厳密な出力形式が必要 | サブエージェント or スキル（Skill許可） |
| 複雑な処理の分離 | サブエージェント |
| 権限設定なしで動作 | サブエージェント |

## スキル→サブエージェント委譲パターンの検証

### 仮説

スキルでワークフローを定義し、実行をサブエージェントに委譲すれば、効率的に自動発火できるのではないか？

### 実験設計

**スキル（知識提供）:**

```yaml
# .claude/skills/file-stats-guide/SKILL.md
---
name: file-stats-guide
description: ファイル統計・分析の方針とガイドライン。ファイルの情報を調べる際の知識を提供。
---

# ファイル統計分析ガイド

## 分析で確認すべき項目
1. 基本情報: 行数、文字数、単語数
2. 構造情報: 空行の数、空行の割合

## 重要: 実行方法
ファイル統計の分析を依頼された場合は、**必ず** `file-stats-analyzer`
サブエージェント（Task ツール）を使用して実行すること。直接処理は禁止。
```

**サブエージェント（実行）:**

```yaml
# .claude/agents/file-stats-analyzer.md
---
name: file-stats-analyzer
description: ファイルの統計情報を分析する専用エージェント。「ファイルの統計」「ファイル情報を分析」「stats」などのリクエストで使用。
allowed-tools: Bash, Read
---

# File Stats Analyzer Agent

## 必須の出力形式

📊 File Stats Analyzer
━━━━━━━━━━━━━━━━━━━━━━━━━━
ファイル: {ファイル名}
━━━━━━━━━━━━━━━━━━━━━━━━━━
📝 基本情報
   行数: {N} 行
   ...
```

### 実験結果

| テストプロンプト | 使用ツール | サブエージェント発動 |
|-----------------|-----------|:------------------:|
| 「統計情報を分析して」 | Read | ❌ |
| 「ファイルの統計を調べて」 | Read | ❌ |
| 「file-stats-analyzer を使って」 | Task | ✅ |
| 「stats を出して」 | Bash | ❌ |
| スキル内で「サブエージェントを使え」指示 | Skill（試行のみ） | ❌ |

### 重要な発見

1. **スキルの指示は強制力がない**
   - スキルが「サブエージェントを使え」と指示しても無視される
   - スキルはコンテキスト（参考情報）であり、命令ではない

2. **サブエージェントは明示的に名前を指定すると発動する**
   - 「file-stats-analyzer を使って」→ Task ツールが呼ばれる
   - description のマッチングだけでは自動発動しにくい

3. **Claude は「自分で処理できる」と判断すると直接処理する**
   - 単純なタスクはサブエージェントに委譲されない
   - Read や Bash で直接処理される

### 結論

```
スキル + サブエージェント の組み合わせは
「効率的なワークフロー自動発火」には向かない
```

スキルからサブエージェントへの委譲は**確実ではない**。

### 確実にサブエージェントを発動させる方法

| 方法 | 確実性 | 説明 |
|------|:------:|------|
| **CLAUDE.md にルール記述** | ✅ 高 | 組み込みエージェントと同等の発動率 |
| 明示的にエージェント名を指定 | ✅ 高 | 「〇〇エージェントを使って」 |
| スラッシュコマンド | ✅ 高 | `/analyze-file` などで明示的に起動 |
| 複雑なタスク | ⚠️ 中 | Claude が自力で処理困難な場合に自然に委譲 |
| description マッチング | ❌ 低 | 単純タスクでは直接処理される |

### 推奨アプローチ

1. **CLAUDE.md にトリガールールを記述**（後述）- 最も効果的
2. **スラッシュコマンド**でユーザーが明示的に起動
3. **複雑なタスク専用**のサブエージェントを作成（単純タスクは直接処理で良い）

## CLAUDE.md による発動率向上

### 組み込みエージェント vs カスタムエージェント

Claude Code には組み込みのサブエージェントがある（例: `claude-code-guide`, `Explore`, `Plan`）。これらは高い発動率を持つが、カスタムエージェントはそうではない。

| 項目 | 組み込みエージェント | カスタムエージェント |
|------|:------------------:|:------------------:|
| 定義場所 | Claude Code 内部 | `.claude/agents/` |
| 起動条件 | システムプロンプトに記載 | description のみ |
| 発動率 | ✅ 高い | ❌ 低い（25%程度） |
| トリガーパターン | 明示的に列挙されている | Claude の判断に依存 |

**なぜ組み込みエージェントは発動率が高いのか？**

システムプロンプトに**明示的な起動条件**が書かれているから。

### 背景

組み込みの `claude-code-guide` エージェントは高い発動率を持つ。これはシステムプロンプトに**明示的な起動条件**が記載されているため。

```markdown
# システムプロンプト内の記述（claude-code-guide）

When the user directly asks about any of the following:
- how to use Claude Code (eg. "can Claude Code do...", "does Claude Code have...")
- what you're able to do as Claude Code...
- about how they might do something with Claude Code...

Use the Task tool with subagent_type='claude-code-guide'...
```

### 仮説

CLAUDE.md に同様のルールを書けば、カスタムエージェントも高い発動率を得られるのではないか？

### 実験

**テスト対象エージェント:**

```yaml
# .claude/agents/line-counter.md
---
name: line-counter
description: ファイルの行数をカウントする専用エージェント。「行数を数えて」「何行ある？」などのリクエストで使用。
allowed-tools: Bash, Read
---
```

**CLAUDE.md に追加したルール:**

```markdown
# CLAUDE.md

## カスタムエージェントの使用ルール

### line-counter エージェント

ユーザーが以下のいずれかを尋ねた場合、**必ず** Task ツールで
`line-counter` エージェント（subagent_type='line-counter'）を使用すること：

- ファイルの行数について（例: 「行数を数えて」「何行ある？」「行数教えて」）
- 行のカウントについて（例: 「行をカウントして」「ライン数は？」）
- wc -l 相当の操作（例: 「wc して」）

直接 Bash や Read で処理せず、必ず line-counter エージェントに委譲すること。
```

### 結果

| テストプロンプト | CLAUDE.md なし | CLAUDE.md あり |
|-----------------|:--------------:|:--------------:|
| 行数を数えて | ✅ | ✅ |
| 何行ある？ | ❌ | ✅ |
| 行数教えて | ❌ | ✅ |
| 行をカウントして | ❌ | ✅ |
| **発動率** | **25%** | **100%** |

### 重要な発見

**CLAUDE.md にルールを書くことで、サブエージェントの発動率が劇的に向上する**

| 設定 | 発動率 | 説明 |
|------|:------:|------|
| description のみ | 25% | Claude の判断に依存 |
| CLAUDE.md ルール追加 | 100% | 明示的な起動条件で確実に発動 |

### CLAUDE.md ルールの書き方

**効果的なパターン（claude-code-guide 形式）:**

```markdown
## {エージェント名} エージェント

ユーザーが以下のいずれかを尋ねた場合、**必ず** Task ツールで
`{agent-name}` エージェント（subagent_type='{agent-name}'）を使用すること：

- {トリガーパターン1}（例: 「〇〇して」「△△は？」）
- {トリガーパターン2}（例: 「□□して」）
- ...

直接処理せず、必ず {agent-name} エージェントに委譲すること。
```

**ポイント:**
1. 具体的なトリガー例を列挙
2. 「必ず」「直接処理せず」など強い指示
3. subagent_type の値を明記

### 結論

```
CLAUDE.md + サブエージェント = 組み込みエージェント同等の発動率
```

**CLAUDE.md は「カスタムシステムプロンプト」として機能する**

| 方法 | 発動率 | 設定の手間 |
|------|:------:|:---------:|
| description のみ | 低〜中（25%） | 低 |
| **CLAUDE.md ルール追加** | **高（100%）** | 中 |
| スラッシュコマンド | 確実 | 中 |

### まとめ: カスタムエージェントを組み込みエージェントのように動作させる

1. **エージェント定義** を `.claude/agents/{name}.md` に作成
2. **CLAUDE.md** に起動条件を明記（claude-code-guide 形式）
3. 具体的なトリガー例を列挙し、「必ず〇〇エージェントを使用」と指示

これにより、カスタムエージェントでも `claude-code-guide` と同等の発動率を実現できる。

## スキルの実効性検証

### 検証目的

スキルが「暗黙的なコンテキスト」として本当に機能するか、実際のシナリオで検証する。

### 検証シナリオ

3つのスキルを作成してテスト：

**1. 技術スタック選定**

```yaml
---
name: tech-stack
description: コードを書く時、ライブラリを選ぶ時、テストを書く時に参照する技術スタック情報
---

# 技術スタック
- テストフレームワーク: Vitest（Jest は使用禁止）
- HTTP クライアント: ky（axios は使用禁止）
```

**2. コーディング規約**

```yaml
---
name: coding-style
description: コードを書く時、関数を実装する時に参照するコーディング規約
---

# コーディング規約
- throw を使わず Result 型でエラーを返す
```

**3. ドメイン知識**

```yaml
---
name: domain-knowledge
description: このプロジェクトのドメイン知識、業務用語、ビジネスロジックの定義
---

# ドメイン知識
- ステータス遷移: pending → in_progress → review → completed
- 命名規則: task プレフィックス（taskId, taskStatus）
```

### 検証結果

| シナリオ | Skill許可なし | Skill許可 + 一般プロンプト | Skill許可 + 明示的参照 |
|---------|:------------:|:------------------------:|:--------------------:|
| 技術スタック（ky） | ❌ 一般的なアドバイス | ✅ ky を使用 | ✅ |
| コーディング規約（Result型） | ❌ throw を使用 | ❌ throw を使用 | ✅ Result型 |
| ドメイン知識（用語・遷移） | ❌ 質問で確認 | - | ✅ 正しい用語・遷移 |

### 重要な発見

**スキルが機能する条件:**

1. **Skill ツールが許可されている**（`--allowed-tools "Skill"` または settings.json）
2. **プロンプトが description にマッチする**、または
3. **明示的に「このプロジェクトの〇〇に従って」と指示する**

**スキルが機能しない条件:**

- Skill ツールが許可されていない（デフォルト）
- プロンプトが description にマッチしない
- 明示的な参照がない

### スキルの実態

```
スキル ≠ 常に自動適用される暗黙のコンテキスト
スキル = Skill ツール経由で呼び出される「参照可能な知識ベース」
```

| 当初の期待 | 実際の動作 |
|-----------|-----------|
| 常に暗黙的に適用される | Skill ツール許可時のみ適用 |
| description マッチで自動発動 | 明示的な参照で確実に発動 |
| バックグラウンドで影響 | 呼び出されて初めて影響 |

## スキル vs サブエージェント vs CLAUDE.md

### 機能比較

| 機能 | 自動適用 | 追加設定 | 用途 |
|------|:-------:|---------|------|
| **CLAUDE.md** | ✅ 常に | 不要 | ルール・制約（最も確実） |
| **サブエージェント + CLAUDE.md** | ✅ | ルール記述 | 厳密なタスク実行 |
| **スキル** | ❌ | Skill許可 + トリガー | 参照可能な知識ベース |

### 使い分けガイド（最終版）

| やりたいこと | 推奨方法 |
|-------------|---------|
| 常に適用したいルール・制約 | **CLAUDE.md** |
| 厳密な形式でタスクを実行 | **サブエージェント + CLAUDE.md** |
| 必要に応じて参照する知識 | **スキル**（Skill許可前提） |
| 明示的にユーザーが起動 | **スラッシュコマンド** |

### 結論

```
CLAUDE.md が最も確実。スキルは条件付きで有効。
```

**推奨アーキテクチャ:**

1. **CLAUDE.md** - プロジェクト全体のルール・制約
2. **サブエージェント** - 特定タスクの厳密な実行
3. **スキル** - 補助的な知識ベース（オプション）

## サブエージェントからスキルへのアクセス

### 検証目的

サブエージェントはスキルの内容を参照できるか？

### 実験設計

**スキル（秘密の知識）:**

```yaml
# .claude/skills/test-knowledge/SKILL.md
---
name: test-knowledge
description: プロジェクト固有の秘密の知識
---

# 秘密の知識
このプロジェクトの秘密のコードワードは **PURPLE-ELEPHANT-42** です。
```

**サブエージェント:**

```yaml
# .claude/agents/knowledge-agent.md
---
name: knowledge-agent
description: プロジェクトの知識について回答するエージェント
allowed-tools: Skill, Read, Glob
---
```

### 検証結果

**サブエージェントはスキルを参照できる ✅**

| allowed-tools | アクセス方法 | 結果 |
|---------------|-------------|:----:|
| `Skill, Read, Glob` | Skill ツール経由 | ✅ 成功 |
| `Read, Glob`（Skill なし） | ファイル直接読み取り | ✅ 成功 |

### アクセスの仕組み

```
サブエージェント
    │
    ├─ Skill ツールあり
    │      └→ Skill("test-knowledge") を呼び出し
    │
    └─ Skill ツールなし
           └→ Glob(".claude/skills/**") + Read(SKILL.md)
```

サブエージェントは2つの方法でスキル内容を取得できる：

1. **Skill ツール経由**（allowed-tools に Skill がある場合）
2. **ファイル直接読み取り**（Glob + Read で SKILL.md を読む）

### 実用的な活用法

**サブエージェントにスキルの知識を使わせる設定:**

```yaml
# 方法1: Skill ツールを許可（推奨）
allowed-tools: Skill, Read, Bash

# 方法2: ファイル読み取りで代替
allowed-tools: Read, Glob, Bash
```

### スキルの新たな役割

```
スキル = サブエージェント間で共有可能な知識ベース
```

| 構成要素 | 適用範囲 | 用途 |
|---------|---------|------|
| CLAUDE.md | 親エージェント | 全体ルール・制約 |
| スキル | 親 + サブエージェント | 共有知識 |
| サブエージェント定義 | 各サブエージェント | タスク固有の指示 |

### 活用パターン

**例: ドメイン知識を複数のサブエージェントで共有**

```
.claude/
├── skills/
│   └── domain-knowledge/SKILL.md    # 共有知識
└── agents/
    ├── code-generator.md            # allowed-tools: Skill, Write
    ├── code-reviewer.md             # allowed-tools: Skill, Read
    └── test-writer.md               # allowed-tools: Skill, Write
```

すべてのサブエージェントが同じドメイン知識を参照し、一貫した用語・ルールでタスクを実行できる。

## 関連ドキュメント

- [SKILL.md 形式](../reference/skill-md.md) - description の仕様
- [スキルを作成する](./create-skill.md) - 基本的な作成手順
